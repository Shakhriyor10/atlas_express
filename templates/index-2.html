{% load static %}
{% load i18n dict_utils %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE|default:'ru' }}">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>AtlasExpress.uz</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-HT0xO3UjGJ3q1gETVjaOQAMgKXZb8YdECuLxA0H3U6YzCvtWyLuUy2bkL5ECMhrI6bbUVVdY0Lh9t8bZ7Wl5mQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="{% static 'css/bootstrap.css' %}">
    <link rel="stylesheet" href="{% static 'css/atlas-theme.css' %}">
    <link rel="shortcut icon" href="{% static 'images/atlas123.png' %}" type="image/x-icon">
    <link rel="icon" href="{% static 'images/atlas123.png' %}" type="image/x-icon">
    {% block extra_styles %}{% endblock %}
</head>
<body data-theme="light">
<div id="preloader">
    <div class="preloader-content">
        <img src="{% static 'images/atlas33.png' %}" class="logo" alt="AtlasExpress">
        <span>{% trans 'Загрузка интерфейса' %}</span>
    </div>
</div>
<div class="page-wrapper">
    <header class="site-header" role="banner">
        <div class="top-bar">
            <div class="top-links">
                <span class="badge-soft"><i class="fa-solid fa-clock"></i> {% trans 'Мы работаем без выходных' %}</span>
                <a href="mailto:atlasexpressuz@gmail.com"><i class="fa-regular fa-envelope"></i> atlasexpressuz@gmail.com</a>
            </div>
            <div class="top-links">
                <div class="socials">
                    <a href="https://www.instagram.com/atlasexpress.usa?igsh=MW9nMGgxYjdqdzV3eA==" target="_blank" rel="noopener" aria-label="Instagram">
                        <i class="fa-brands fa-instagram"></i>
                    </a>
                    <a href="https://www.facebook.com/profile.php?id=61561937198092&mibextid=LQQJ4d" target="_blank" rel="noopener" aria-label="Facebook">
                        <i class="fa-brands fa-facebook"></i>
                    </a>
                    <a href="https://t.me/AtlasExpressUS" target="_blank" rel="noopener" aria-label="Telegram">
                        <i class="fa-brands fa-telegram"></i>
                    </a>
                </div>
                <a class="muted" href="tel:+998772933300"><i class="fa-solid fa-phone"></i> +998 77 293 33 00</a>
            </div>
        </div>
        <div class="navbar">
            <a class="logo" href="{% url 'home' %}">
                <img src="{% static 'images/atlas_logo3.png' %}" alt="Atlas Express">
                <span>Atlas Express</span>
            </a>
            <button class="nav-toggle" id="navToggle" aria-label="Toggle navigation"><i class="fa-solid fa-bars"></i></button>
            <nav class="nav-links" id="navLinks" role="navigation">
                <a href="{% url 'home' %}" class="{% if request.path == '/' %}active{% endif %}">{% trans 'Главная' %}</a>
                <div class="nav-dropdown" data-dropdown>
                    <button type="button">
                        {% trans 'Контакты' %}
                        <i class="fa-solid fa-chevron-down"></i>
                    </button>
                    <div class="dropdown-menu-custom">
                        <a href="{% url 'contacts' %}" class="{% if request.path == '/contacts/' %}active{% endif %}">{% trans 'Все контакты' %}</a>
                        {% for country in countries %}
                            <div>
                                <a href="{% url 'contacts' %}?country={{ country.id }}" class="dropdown-heading">{{ country.title }}</a>
                                {% with cities_by_country|dict_get:country.id as cities %}
                                    {% if cities %}
                                        <div class="stack" style="padding-left: 12px;">
                                            {% for city in cities %}
                                                <a href="{% url 'contacts' %}?country={{ country.id }}&city={{ city.id }}" class="muted">{{ city.title }}</a>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                {% endwith %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="nav-dropdown" data-dropdown>
                    <button type="button">
                        {% trans 'Тарифы' %}
                        <i class="fa-solid fa-chevron-down"></i>
                    </button>
                    <div class="dropdown-menu-custom">
                        <a href="{% url 'rates' %}">{% trans 'Все тарифы' %}</a>
                        {% for category in rate_categories %}
                            <a href="{% url 'rates_by_category' category.pk %}">{{ category.sender_recipient }}</a>
                        {% endfor %}
                    </div>
                </div>
                <a href="{% url 'tracking_details' %}">{% trans 'Отследить' %}</a>
            </nav>
            <div class="header-actions">
                <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
                    <i class="fa-solid fa-moon"></i>
                </button>
                <div class="language-switcher">
                    <button type="button">
                        <i class="fa-solid fa-globe"></i>
                        {% if LANGUAGE_CODE == 'en' %}English{% else %}Русский{% endif %}
                        <i class="fa-solid fa-chevron-down"></i>
                    </button>
                    <div class="language-menu">
                        <form method="post" action="{% url 'set_language' %}">
                            {% csrf_token %}
                            <button type="submit" name="language" value="ru" class="{% if LANGUAGE_CODE == 'ru' %}active{% endif %}">Русский</button>
                            <button type="submit" name="language" value="en" class="{% if LANGUAGE_CODE == 'en' %}active{% endif %}">English</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main>
        {% block content %}
        <section class="hero" id="hero">
            <div class="container">
                <div class="hero-content">
                    <span class="chip">{% trans 'Международная доставка' %}</span>
                    <h1>{% trans 'Доставляем посылки быстро и безопасно' %}</h1>
                    <p>{% trans 'Atlas Express соединяет США и Узбекистан, обеспечивая прозрачный контроль каждой посылки и сервис класса Premium.' %}</p>
                    <div class="hero-actions">
                        <a class="btn btn-primary" href="{% url 'rates' %}"><i class="fa-solid fa-plane-departure"></i> {% trans 'Посмотреть тарифы' %}</a>
                        <a class="btn btn-outline" href="{% url 'contacts' %}"><i class="fa-solid fa-comments"></i> {% trans 'Связаться с нами' %}</a>
                    </div>
                    <div class="hero-stats">
                        <div class="stat-card">
                            <span class="chip"><i class="fa-solid fa-globe"></i> {% trans 'География' %}</span>
                            <div>
                                <strong>{{ countries|length|default:0 }} {% trans 'страны присутствия' %}</strong>
                                <div>{% trans 'Представительства и пункты выдачи в США и Узбекистане' %}</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <span class="chip"><i class="fa-solid fa-shield-heart"></i> {% trans 'Контроль' %}</span>
                            <div>
                                <strong>{% trans '24/7 мониторинг отправлений' %}</strong>
                                <div>{% trans 'Актуальный статус посылок в личном кабинете и по номеру трека' %}</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="hero-card">
                    <h3>{% trans 'Отследить посылку' %}</h3>
                    <form method="post" action="{% url 'track_package' %}" class="track-form">
                        {% csrf_token %}
                        <div class="input-group">
                            <input type="text" name="trackid" placeholder="{% trans 'Введите ID посылки' %}" required>
                        </div>
                        <button class="btn btn-primary" type="submit"><i class="fa-solid fa-magnifying-glass"></i> {% trans 'Проверить статус' %}</button>
                        <span class="helper-text"><i class="fa-regular fa-lightbulb"></i> {% trans 'Мы покажем последние обновления и примерную дату доставки.' %}</span>
                    </form>
                </div>
            </div>
        </section>

        <section class="section" id="services">
            <div class="container">
                <div class="section-header">
                    <span class="chip"><i class="fa-solid fa-star"></i> {% trans 'Почему Atlas Express' %}</span>
                    <h2>{% trans 'Сервис, созданный для вашего комфорта' %}</h2>
                    <p>{% trans 'Комплексное сопровождение от оформления заказа до доставки в пункт выдачи. Никаких скрытых платежей и максимум заботы.' %}</p>
                </div>
                <div class="feature-grid">
                    <article class="feature-card">
                        <div class="feature-icon"><i class="fa-solid fa-gauge-high"></i></div>
                        <h3>{% trans 'Скорость и точность' %}</h3>
                        <p>{% trans 'Оптимизированная логистика и цифровые инструменты позволяют доставлять заказы точно в срок.' %}</p>
                    </article>
                    <article class="feature-card">
                        <div class="feature-icon"><i class="fa-solid fa-box-open"></i></div>
                        <h3>{% trans 'Надёжная упаковка' %}</h3>
                        <p>{% trans 'Каждая посылка проходит контроль и дополнительную защиту, чтобы доехать в идеальном состоянии.' %}</p>
                    </article>
                    <article class="feature-card">
                        <div class="feature-icon"><i class="fa-solid fa-headset"></i></div>
                        <h3>{% trans 'Персональная поддержка' %}</h3>
                        <p>{% trans 'Команда саппорта отвечает на вопросы в мессенджерах и помогает на каждом этапе пути.' %}</p>
                    </article>
                    <article class="feature-card">
                        <div class="feature-icon"><i class="fa-solid fa-shield-halved"></i></div>
                        <h3>{% trans 'Прозрачность и безопасность' %}</h3>
                        <p>{% trans 'Мы работаем официально, предоставляя страховку и прозрачные отчёты по каждой доставке.' %}</p>
                    </article>
                </div>
            </div>
        </section>

        <section class="section rates-section" id="rates">
            <div class="container">
                <div class="section-header">
                    <span class="chip"><i class="fa-solid fa-scale-balanced"></i> {% trans 'Актуальные тарифы' %}</span>
                    <h2>{% trans 'Выберите подходящее предложение' %}</h2>
                    <p>{% trans 'Выгодные условия для личных и корпоративных отправлений. Лучшие цены на доставку из США.' %}</p>
                </div>
                {% if rates %}
                    <div class="rates-grid">
                        {% for rate in rates %}
                            <article class="rate-card {% if rate.is_hot %}hot{% endif %}">
                                {% if rate.is_hot %}
                                    <span class="badge">🔥 {% trans 'Популярный тариф' %}</span>
                                {% else %}
                                    <span class="badge">{{ rate.country }}</span>
                                {% endif %}
                                <div>
                                    <div class="price-tag">{{ rate.price }}$ <span>/{% trans 'кг' %}</span></div>
                                    <div class="rate-meta">
                                        <span>📦 {{ rate.rate_title }}</span>
                                        <span>⏱ {% trans 'Доставка:' %} {{ rate.delivery_within }} {% trans 'дней' %}</span>
                                        <span>⚖️ {% trans 'Минимальный вес:' %} {{ rate.minimal_weight }} {% trans 'кг' %}</span>
                                    </div>
                                </div>
                                <a class="btn btn-outline" href="{% url 'rates' %}"><i class="fa-solid fa-arrow-up-right-from-square"></i> {% trans 'Смотреть все тарифы' %}</a>
                            </article>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center muted">{% trans 'Тарифы временно недоступны, свяжитесь с менеджером для уточнения.' %}</div>
                {% endif %}
            </div>
        </section>

        <section class="section journey-section" id="journey">
            <div class="container">
                <div class="section-header">
                    <span class="chip"><i class="fa-solid fa-route"></i> {% trans 'Как это работает' %}</span>
                    <h2>{% trans 'Путь вашей посылки' %}</h2>
                    <p>{% trans 'Мы делаем международную доставку простой: от приёма в США до вручения в Узбекистане всего несколько шагов.' %}</p>
                </div>
                <div class="timeline">
                    <div class="timeline-step active">
                        <div class="dot">1</div>
                        <div>
                            <h4>{% trans 'Приём и проверка' %}</h4>
                            <p>{% trans 'Забираем посылку в США, проверяем содержимое и подготавливаем документы.' %}</p>
                        </div>
                    </div>
                    <div class="timeline-step active">
                        <div class="dot">2</div>
                        <div>
                            <h4>{% trans 'Консолидация и отправка' %}</h4>
                            <p>{% trans 'Объединяем грузы, страхуем и отправляем на рейсе в Узбекистан.' %}</p>
                        </div>
                    </div>
                    <div class="timeline-step">
                        <div class="dot">3</div>
                        <div>
                            <h4>{% trans 'Таможенное оформление' %}</h4>
                            <p>{% trans 'Работаем напрямую с таможенными органами, чтобы ускорить прохождение контроля.' %}</p>
                        </div>
                    </div>
                    <div class="timeline-step">
                        <div class="dot">4</div>
                        <div>
                            <h4>{% trans 'Выдача или доставка' %}</h4>
                            <p>{% trans 'Передаём в пункт выдачи или организуем адресную доставку в вашем городе.' %}</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="section addresses-section" id="network">
            <div class="container">
                <div class="section-header">
                    <span class="chip"><i class="fa-solid fa-map-location-dot"></i> {% trans 'Наша сеть' %}</span>
                    <h2>{% trans 'Адреса представительств и складов' %}</h2>
                    <p>{% trans 'Выбирайте удобный пункт выдачи для получения посылки. Мы расширяем сеть и добавляем новые локации.' %}</p>
                </div>
                <div class="address-grid">
                    {% for address in addresses %}
                        <article class="address-card">
                            {% if address.city and address.city.country %}
                                <span class="badge-soft">{{ address.city.country.title }}</span>
                            {% endif %}
                            <h4>{{ address.title }}</h4>
                            {% if address.city %}
                                <span><i class="fa-solid fa-location-dot"></i> {{ address.city }}</span>
                            {% endif %}
                            {% if address.phone %}
                                <span><i class="fa-solid fa-phone"></i> {{ address.phone }}</span>
                            {% endif %}
                            {% if address.coordinates1 %}
                                <a class="btn btn-outline" href="https://www.google.com/maps?q={{ address.coordinates1 }}" target="_blank" rel="noopener">
                                    <i class="fa-solid fa-map"></i> {% trans 'Открыть в Google Maps' %}
                                </a>
                            {% endif %}
                        </article>
                    {% empty %}
                        <div class="muted">{% trans 'Контакты временно недоступны.' %}</div>
                    {% endfor %}
                </div>
            </div>
        </section>

        <section class="cta-section" id="cta">
            <div class="container">
                <div class="cta-card">
                    <h2>{% trans 'Готовы отправить посылку?' %}</h2>
                    <p>{% trans 'Оставьте заявку и мы подберём оптимальный способ доставки, рассчитаем стоимость и сопроводим до вручения.' %}</p>
                    <a class="btn btn-primary" href="{% url 'contacts' %}"><i class="fa-solid fa-paper-plane"></i> {% trans 'Связаться с менеджером' %}</a>
                </div>
            </div>
        </section>
        {% endblock %}
    </main>

    <footer class="site-footer">
        <div class="footer-grid">
            <div>
                <a class="logo" href="{% url 'home' %}">
                    <img src="{% static 'images/atlas_logo3.png' %}" alt="Atlas Express">
                    <span>Atlas Express</span>
                </a>
                <p class="muted">{% trans 'Atlas Express — современный сервис международной доставки с фокусом на скорость, безопасность и заботу о клиентах.' %}</p>
            </div>
            <div>
                <h4>{% trans 'Навигация' %}</h4>
                <ul>
                    <li><a href="{% url 'home' %}">{% trans 'Главная' %}</a></li>
                    <li><a href="{% url 'rates' %}">{% trans 'Тарифы' %}</a></li>
                    <li><a href="{% url 'contacts' %}">{% trans 'Контакты' %}</a></li>
                    <li><a href="{% url 'tracking_details' %}">{% trans 'Отследить посылку' %}</a></li>
                </ul>
            </div>
            <div>
                <h4>{% trans 'Связаться' %}</h4>
                <ul>
                    <li><a href="mailto:atlasexpressuz@gmail.com"><i class="fa-regular fa-envelope"></i> atlasexpressuz@gmail.com</a></li>
                    <li><a href="tel:+998772933300"><i class="fa-solid fa-phone"></i> +998 77 293 33 00</a></li>
                    <li><a href="https://t.me/AtlasExpressUS" target="_blank" rel="noopener"><i class="fa-brands fa-telegram"></i> Telegram</a></li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            <span>© {% now "Y" %} Atlas Express</span>
            <span class="muted">{% trans 'Все права защищены' %}</span>
        </div>
    </footer>
</div>

<div class="modal fade" id="resultModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content my-modal-content">
            <div class="modal-header my-modal-header">
                <h5 class="modal-title"><i class="fa-solid fa-box"></i> {% trans 'Статус посылки' %}</h5>
                <button type="button" class="close my-modal-close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body my-modal-body" id="modalBody"></div>
            <div class="modal-footer my-modal-footer" id="modalFooter"></div>
        </div>
    </div>
</div>

<script src="{% static 'js/jquery-3.5.1.min.js' %}"></script>
<script src="{% static 'js/popper.min.js' %}"></script>
<script src="{% static 'js/bootstrap.min.js' %}"></script>
<script>
    const navToggle = document.getElementById('navToggle');
    const navLinks = document.getElementById('navLinks');
    const dropdowns = document.querySelectorAll('.nav-dropdown');

    if (navToggle) {
        navToggle.addEventListener('click', () => {
            navLinks.classList.toggle('open');
        });
    }

    dropdowns.forEach(dropdown => {
        const button = dropdown.querySelector('button');
        button?.addEventListener('click', (event) => {
            if (window.innerWidth <= 1024) {
                event.preventDefault();
                dropdown.classList.toggle('open');
            }
        });
    });

    const themeToggle = document.getElementById('themeToggle');
    const body = document.body;
    const savedTheme = localStorage.getItem('atlas-theme');

    if (savedTheme) {
        body.setAttribute('data-theme', savedTheme);
        updateThemeIcon(savedTheme);
    }

    themeToggle?.addEventListener('click', () => {
        const current = body.getAttribute('data-theme');
        const next = current === 'dark' ? 'light' : 'dark';
        body.setAttribute('data-theme', next);
        localStorage.setItem('atlas-theme', next);
        updateThemeIcon(next);
    });

    function updateThemeIcon(theme) {
        if (!themeToggle) return;
        const icon = themeToggle.querySelector('i');
        if (!icon) return;
        icon.className = theme === 'dark' ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
    }

    function sendTracking(form) {
        const fd = new FormData(form);
        fetch(form.action, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: fd
        })
        .then(response => {
            if (!response.ok) throw new Error('{% trans "Ничего не найдено" %}');
            const contentType = response.headers.get('Content-Type') || '';
            if (!contentType.includes('application/json')) {
                throw new Error('{% trans "Ожидался ответ сервера в формате JSON" %}');
            }
            return response.json();
        })
        .then(data => {
            if (data.error) throw new Error(data.error);
            let statusText;
            switch (data.status) {
                case 'in_warehouse':
                    statusText = '{% trans "На складе" %}';
                    break;
                case 'location':
                    statusText = '{% trans "Местоположение" %}';
                    break;
                case 'packed':
                    statusText = '{% trans "Упакован" %}';
                    break;
                case 'shipped':
                    statusText = '{% trans "Отправлен" %}';
                    break;
                case 'in_customs':
                    statusText = '{% trans "На таможне" %}';
                    break;
                case 'arrive_warehouse':
                    statusText = '{% trans "Прибыл на склад" %}';
                    break;
                case 'accept_location':
                    statusText = '{% trans "Принято в местоположение" %}';
                    break;
                case 'out_location':
                    statusText = '{% trans "Вышел из местоположения" %}';
                    break;
                case 'delivered':
                    statusText = '{% trans "Доставлено" %}';
                    break;
                default:
                    statusText = data.status;
            }

            let dateLabel = '{% trans "Дата прибытия" %}';
            let dateValue = data.estimatedArrival;
            if (data.status === 'delivered') {
                dateLabel = '{% trans "Доставлено" %}';
                dateValue = data.updatedAt ? data.updatedAt.split(' ')[0] : data.estimatedArrival;
            }

            document.getElementById('modalBody').innerHTML = `
                <div class="stack">
                    <div class="info-card">
                        <strong>ID</strong>
                        <span class="h5 mb-0">${data.id}</span>
                    </div>
                    <div class="info-card">
                        <strong>{% trans 'Статус' %}</strong>
                        <span>${statusText}</span>
                    </div>
                    <div class="info-card">
                        <strong>${dateLabel}</strong>
                        <span>${dateValue}</span>
                    </div>
                </div>`;
            document.getElementById('modalFooter').innerHTML = `
                <a href="/tracking/${data.id}/" class="btn btn-primary">
                    <i class="fa-solid fa-arrow-right"></i> {% trans 'Подробнее' %}
                </a>`;
            $('#resultModal').modal('show');
        })
        .catch(error => {
            console.error(error);
            document.getElementById('modalBody').innerHTML = `
                <div class="alert alert-warning text-center" role="alert">
                    ${error.message}
                </div>`;
            document.getElementById('modalFooter').innerHTML = '';
            $('#resultModal').modal('show');
        });
    }

    document.querySelectorAll('.track-form').forEach(form => {
        form.addEventListener('submit', event => {
            event.preventDefault();
            sendTracking(form);
        });
    });

    window.addEventListener('load', function () {
        setTimeout(function () {
            const preloader = document.getElementById('preloader');
            if (!preloader) return;
            preloader.style.opacity = '0';
            setTimeout(() => preloader.style.display = 'none', 400);
        }, 1200);
    });
</script>
{% block extra_scripts %}{% endblock %}
</body>
</html>
