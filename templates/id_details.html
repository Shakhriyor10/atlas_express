{% extends 'index-2.html' %}
{% load static %}
{% load i18n dict_utils %}

{% block content %}
<section class="section" id="tracking-details">
    <div class="container">
        <div class="section-header">
            <span class="chip"><i class="fa-solid fa-compass"></i> {% trans 'Отслеживание' %}</span>
            <h2>{% trans 'Подробный статус доставки' %}</h2>
            <p>{% trans 'Следите за каждым этапом движения посылки. Обновления подтягиваются автоматически из системы Atlas Express.' %}</p>
        </div>

        <div class="form-card" style="margin-bottom: 40px;">
            <form method="post" class="track-form" action="{% url 'tracking_details' %}">
                {% csrf_token %}
                <div class="form-row">
                    <label for="track-id">{% trans 'Введите ID посылки' %}</label>
                    <input id="track-id" type="text" name="trackid" value="{{ trackid }}" placeholder="{% trans 'Например, AT-458921' %}" required>
                </div>
                <div class="form-row">
                    <button type="submit" class="btn btn-primary">
                        <i class="fa-solid fa-magnifying-glass"></i> {% trans 'Обновить статус' %}
                    </button>
                </div>
            </form>
            {% if error %}
                <div class="alert alert-warning mt-3" role="alert">{{ error }}</div>
            {% endif %}
        </div>

        {% if data %}
            <div class="tracking-wrapper">
                <div class="stack" style="margin-bottom: 24px;">
                    <div class="info-card">
                        <strong>{% trans 'Номер отправления' %}</strong>
                        <span class="h4 mb-0">{{ data.id }}</span>
                        <span class="muted">{% trans 'Последнее обновление:' %} {{ data.updatedAt }}</span>
                    </div>
                    <div class="info-card">
                        <strong>{% trans 'Тип отправления' %}</strong>
                        <span>{{ data.shipmentType.name|default:'—' }}</span>
                        {% if data.weight %}
                            <span class="muted">{% trans 'Вес:' %} {{ data.weight }} кг</span>
                        {% endif %}
                    </div>
                    <div class="info-card">
                        <strong>{% trans 'Текущий статус' %}</strong>
                        <span>
                            {% if data.status == "in_warehouse" %}
                                {% trans "На складе" %}
                            {% elif data.status == "location" %}
                                {% trans "Местоположение" %}
                            {% elif data.status == "packed" %}
                                {% trans "Упакован" %}
                            {% elif data.status == "shipped" %}
                                {% trans "Отправлен" %}
                            {% elif data.status == "in_customs" %}
                                {% trans "На таможне" %}
                            {% elif data.status == "arrive_warehouse" %}
                                {% trans "Прибыл на склад" %}
                            {% elif data.status == "accept_location" %}
                                {% trans "Принято в местоположение" %}
                            {% elif data.status == "out_location" %}
                                {% trans "Вышел из местоположения" %}
                            {% elif data.status == "delivered" %}
                                {% trans "Доставлено" %}
                            {% else %}
                                {{ data.status }}
                            {% endif %}
                        </span>
                        {% if data.currentLocation.address or data.currentLocation.name %}
                            <span class="muted">{% trans 'Текущее местоположение:' %} {{ data.currentLocation.name|default:data.currentLocation.address }}</span>
                        {% endif %}
                    </div>
                </div>

                <div class="tracking-steps">
                    {% for code, label in steps %}
                        {% if code != 'delivered' or data.status == 'delivered' %}
                            {% with idx=forloop.counter0 %}
                                <div class="track-step{% if current_index != -1 and idx < current_index %} completed{% endif %}{% if current_index != -1 and idx == current_index %} active{% endif %}">
                                    <h4>{{ label }}</h4>
                                    <span>
                                        {% if current_index == -1 %}
                                            {% trans 'Ожидается обновление' %}
                                        {% elif idx < current_index %}
                                            {% trans 'Выполнено' %}
                                        {% elif idx == current_index and code == 'accept_location' and data.arrival_range %}
                                            {{ data.arrival_range }}
                                        {% elif idx == current_index and data.status == 'delivered' %}
                                            {{ data.updatedDateOnly }} {{ data.updatedDateOnlyTime }}
                                        {% elif idx == current_index %}
                                            {{ data.currentLocation.name|default:data.currentLocation.address|default:_('В процессе') }}
                                        {% elif code == 'accept_location' and data.arrival_range %}
                                            {{ data.arrival_range }}
                                        {% elif code == 'delivered' and data.updatedDateOnly %}
                                            {{ data.updatedDateOnly }}
                                        {% else %}
                                            {% trans 'Ожидается' %}
                                        {% endif %}
                                    </span>
                                </div>
                            {% endwith %}
                        {% endif %}
                    {% endfor %}
                </div>

                <div class="stack" style="margin-top: 32px;">
                    {% if data.status != 'delivered' %}
                        <div class="info-card">
                            <strong>{% trans 'Ориентировочная доставка' %}</strong>
                            <span>{{ data.arrival_range|default:_('Дата уточняется') }}</span>
                        </div>
                    {% else %}
                        <div class="info-card">
                            <strong>{% trans 'Посылка доставлена' %}</strong>
                            <span>{{ data.updatedDateOnly }} {{ data.updatedDateOnlyTime }}</span>
                        </div>
                    {% endif %}
                </div>
            </div>
        {% else %}
            {% if not error %}
                <div class="text-center muted">{% trans 'Введите ID посылки, чтобы увидеть детали отслеживания.' %}</div>
            {% endif %}
        {% endif %}
    </div>
</section>
{% endblock %}
